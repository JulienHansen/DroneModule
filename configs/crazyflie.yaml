# ============================================================
# Crazyflie 2.1 — drone configuration
# ============================================================
# Gains match the Crazyflie firmware cascade PID (pid_attitude.c)
# adapted for the vectorized Python simulation.
#
# Unit conventions:
#   mass          [kg]
#   inertia       [kg·m²]
#   max_thrust    [N]  — total thrust of all 4 motors combined
#   freq_*_hz     [Hz]
#   PID limits    [same unit as PID output]
#     rate  loop output  = angular acceleration  [rad/s²]
#     angle loop output  = angular rate          [rad/s]
#     vel   loop output  = linear  acceleration  [m/s²]
#     pos   loop output  = linear  velocity      [m/s]
# ============================================================

drone:
  name: "Crazyflie 2.1"
  mass: 0.027            # kg  (~27 g)
  inertia:               # Principal moments, diagonal tensor [kg·m²]
    ixx: 1.657e-5
    iyy: 1.657e-5
    izz: 2.900e-5
  max_thrust: 0.638      # N  (4 × ~160 mN brushless motors, measured)

  # Motor & frame geometry  (needed by QuadMixer)
  motor:
    arm_length: 0.046      # m   — center-to-motor distance
    k_thrust:   1.285e-8   # N·s²  — F = k_thrust · ω²  (sysid: Förster 2015)
    k_drag:     7.645e-11  # N·m·s² — τ = k_drag · ω²
    layout:     x          # 'x' — standard X-quad configuration
    speed_min:  0.0        # rad/s
    speed_max:  2618.0     # rad/s  (~25 000 RPM)

controllers:

  # ----------------------------------------------------------
  # Attitude controller  (angle outer loop + rate inner loop)
  # ----------------------------------------------------------
  attitude:
    freq_rate_hz:  100   # Inner (rate)  loop frequency
    freq_angle_hz: 100   # Outer (angle) loop frequency

    # Inner loop: body-rate error [rad/s] → angular acceleration [rad/s²]
    # Limit = 8 rev/s = 8 × 2π rad/s² ≈ 50.265 rad/s²
    rate:
      roll:  { kp: 50.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 50.265 }
      pitch: { kp: 50.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 50.265 }
      yaw:   { kp: 50.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 50.265 }

    # Outer loop: angle error [rad] → body-rate setpoint [rad/s]
    # Limit = 2.5 rev/s = 2.5 × 2π rad/s ≈ 15.708 rad/s
    angle:
      roll:  { kp: 4.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 15.708 }
      pitch: { kp: 4.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 15.708 }
      yaw:   { kp: 3.0, ki: 0.0, kd: 0.0, tau: 0.01, limit: 15.708 }

  # ----------------------------------------------------------
  # Position controller  (position outer loop + velocity inner loop)
  # ----------------------------------------------------------
  position:
    freq_vel_hz: 100     # Inner (velocity) loop frequency
    freq_pos_hz: 100     # Outer (position) loop frequency

    # Safety cap on thrust: effective max = max_thrust_scale × drone.max_thrust
    max_thrust_scale: 0.8

    # Maximum roll/pitch angle commanded by the velocity controller [deg]
    max_horizontal_angle_deg: 30.0

    # Inner loop: velocity error [m/s] → acceleration setpoint [m/s²]
    # (high limit = virtually unclamped; saturation handled geometrically for xy)
    velocity:
      vx: { kp: 1.0, ki: 0.0, kd: 0.0, tau: 0.10, limit: 9999.0 }
      vy: { kp: 1.0, ki: 0.0, kd: 0.0, tau: 0.10, limit: 9999.0 }
      vz: { kp: 1.0, ki: 0.0, kd: 0.0, tau: 0.10, limit: 9999.0 }

    # Outer loop: position error [m] → velocity setpoint [m/s]
    position:
      x: { kp: 5.0, ki: 0.0, kd: 1.0, tau: 0.10, limit: 10.0 }
      y: { kp: 5.0, ki: 0.0, kd: 1.0, tau: 0.10, limit: 10.0 }
      z: { kp: 5.0, ki: 0.0, kd: 3.5, tau: 0.10, limit:  5.0 }

  # ----------------------------------------------------------
  # CascadePIDController  (firmware-style multi-rate cascade)
  # ----------------------------------------------------------
  # Gains match pid_attitude.c / pid_position.c from the Crazyflie firmware.
  #
  # Unit conventions:
  #   pos gains     — output in [m/s]        (vel setpoint)
  #   vel gains     — output in [deg] or [m/s²] (see note below)
  #   att gains     — output in [rad/s]       (rate setpoint)
  #   rate gains    — output in [rad/s²]      (angular acceleration)
  #
  # Note: vel_kp/ki/kd for x/y are in deg/s per (m/s) — the controller
  # multiplies them by DEG2RAD internally, so the numbers here match the
  # firmware's integer register values.
  # ----------------------------------------------------------
  cascade_pid:
    sim_rate_hz:            500.0   # Expected simulation / call rate [Hz]
    pid_posvel_loop_rate_hz: 100.0  # Position + velocity loop rate [Hz]
    pid_loop_rate_hz:        500.0  # Attitude + rate loop rate [Hz]

    # ── Position loop  (error [m] → velocity setpoint [m/s]) ──────────────
    pos_kp:  [2.0,  2.0,  2.0]
    pos_ki:  [0.0,  0.0,  0.5]
    pos_kd:  [0.0,  0.0,  0.0]
    pos_kff: [0.0,  0.0,  0.0]

    # ── Velocity loop  (error [m/s] → roll/pitch cmd [deg] or thrust Δ) ──
    vel_kp:  [25.0, 25.0,  25.0]
    vel_ki:  [ 1.0,  1.0,  15.0]
    vel_kd:  [ 0.0,  0.0,   0.0]
    vel_kff: [ 0.0,  0.0,   0.0]

    # ── Attitude loop  (error [rad] → body-rate setpoint [rad/s]) ─────────
    att_kp:  [6.0, 6.0, 6.0]
    att_ki:  [3.0, 3.0, 1.0]
    att_kd:  [0.0, 0.0, 0.35]
    att_kff: [0.0, 0.0, 0.0]

    # ── Rate loop  (error [rad/s] → angular acceleration [rad/s²]) ────────
    rate_kp:  [250.0, 250.0, 120.0]
    rate_ki:  [500.0, 500.0,  16.7]
    rate_kd:  [  2.5,   2.5,   0.0]
    rate_kff: [  0.0,   0.0,   0.0]

    # ── Gyroscope low-pass filter ──────────────────────────────────────────
    # Matches the Crazyflie firmware Butterworth LPF on the gyro (~80 Hz).
    # Applied only to the derivative path of the rate loop.
    # Set to 0 to disable.
    gyro_lpf_cutoff_hz: 20.0

    # ── Saturation limits ──────────────────────────────────────────────────
    att_integral_limit_deg:  [20.0, 20.0, 360.0]   # per-axis integral cap [deg]
    rate_integral_limit_deg: [33.3, 33.3, 166.7]   # per-axis integral cap [deg/s]
    pos_vel_max: [2.0, 2.0, 1.5]                   # max velocity setpoint [m/s]
    roll_max_deg:  30.0
    pitch_max_deg: 30.0
    yaw_max_delta: 0.0   # 0 = unlimited yaw rate

    # ── Thrust  (Crazyflie PWM units: 0 – 65 535) ─────────────────────────
    # thrust_cmd_scale is derived automatically from drone.max_thrust.
    thrust_base:    30000.0   # Hover throttle estimate [PWM]
    thrust_min:     20000.0   # Minimum throttle [PWM]
    thrust_cmd_max: 65535.0   # Full-scale throttle [PWM]
    vel_thrust_scale: 1000.0  # (m/s²) → PWM conversion

  # ----------------------------------------------------------
  # Lee geometric controller  (Lee et al., CDC 2010)
  # ----------------------------------------------------------
  # All gains operate in SI units throughout.
  #
  # Unit conventions:
  #   position_gain     [N/m]         pos error [m]     → force     [N]
  #   velocity_gain     [N·s/m]       vel error [m/s]   → force     [N]
  #   attitude_gain     [N·m/rad]     att error [rad]   → moment    [N·m]
  #   angular_rate_gain [N·m·s/rad]   rate error [rad/s]→ moment    [N·m]
  #
  # Tuned for Crazyflie 2.1 (mass = 0.027 kg, I ≈ 1.66e-5 kg·m²).
  # Derived via pole placement (ω_pos ≈ 4 rad/s, ω_att ≈ 60 rad/s, ζ = 0.7).
  # ----------------------------------------------------------
  lee:
    position_gain:     [0.50, 0.50, 0.70]    # k_pos
    velocity_gain:     [0.20, 0.20, 0.30]    # k_vel
    attitude_gain:     [0.06, 0.06, 0.030]   # k_R
    angular_rate_gain: [0.002, 0.002, 0.001] # k_Omega
